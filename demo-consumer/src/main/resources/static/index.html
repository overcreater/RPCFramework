<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>RPC å¾®æœåŠ¡ç»¼åˆæ§åˆ¶å°</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; font-weight: 600; }

        /* é€šç”¨åˆ†åŒºæ ·å¼ */
        .section { margin-bottom: 30px; padding: 25px; background: #fff; border-radius: 8px; border: 1px solid #e1e4e8; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .section h3 { margin-top: 0; color: #444; border-left: 5px solid #007bff; padding-left: 10px; display: flex; align-items: center; }

        /* æ§ä»¶å¸ƒå±€ */
        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-top: 15px; }
        input { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; width: 150px; outline: none; transition: 0.2s; }
        input:focus { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }

        button { padding: 10px 20px; cursor: pointer; color: white; border: none; border-radius: 4px; font-weight: 600; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(0); }

        .btn-blue { background: linear-gradient(135deg, #007bff, #0056b3); }
        .btn-green { background: linear-gradient(135deg, #28a745, #1e7e34); }
        .btn-purple { background: linear-gradient(135deg, #6f42c1, #563d7c); }
        .btn-orange { background: linear-gradient(135deg, #fd7e14, #e35d0b); } /* è®¢å•ä¸“ç”¨è‰² */
        .btn-gray { background: #6c757d; }

        /* ç»“æœå±•ç¤ºåŒº */
        .result-box { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #adb5bd; font-family: monospace; color: #333; min-height: 20px; word-break: break-all;}

        /* è´Ÿè½½å‡è¡¡å¯è§†åŒ–æ–¹å— */
        #monitor { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 15px; min-height: 100px; max-height: 300px; overflow-y: auto; padding: 5px;}
        .block {
            width: 70px; height: 35px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; color: white; font-weight: bold;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .stats { margin-top: 15px; font-weight: bold; display: flex; gap: 20px; padding: 10px; background: #f1f3f5; border-radius: 6px;}
        .badge { padding: 2px 8px; border-radius: 10px; color: white; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ RPC å¾®æœåŠ¡æ§åˆ¶å°</h1>

    <div class="section">
        <h3>ğŸ›’ è®¢å•æœåŠ¡ (Order Service)</h3>
        <p style="color: #666; font-size: 0.9em;">æ¨¡æ‹Ÿç”µå•†ä¸‹å•æµç¨‹ï¼Œæµ‹è¯•åŸºæœ¬ RPC é€šä¿¡ã€‚</p>
        <div class="controls">
            <label>å•†å“ID: <input type="text" id="orderId" value="PROD-8888"></label>
            <button class="btn-orange" onclick="createOrder()">ğŸ“¦ ç«‹å³ä¸‹å•</button>
        </div>
        <div id="orderResult" class="result-box" style="border-left-color: #fd7e14;">ç­‰å¾…ä¸‹å•...</div>
    </div>

    <div class="section">
        <h3>ğŸ§® è®¡ç®—æœåŠ¡è°ƒè¯• (Manual Debug)</h3>
        <p style="color: #666; font-size: 0.9em;">æ‰‹åŠ¨éªŒè¯ï¼šå•æœºé”å®š IP vs è´Ÿè½½å‡è¡¡éšæœº IPã€‚</p>
        <div class="controls">
            <label>è®¡ç®—æ¬¡æ•°: <input type="number" id="debugCount" value="5000"></label>
            <button class="btn-purple" onclick="testApi('/calc/single', 'debugResult')">æµ‹è¯•ï¼šå•æœºé”å®š</button>
            <button class="btn-blue" onclick="testApi('/calc/balance', 'debugResult')">æµ‹è¯•ï¼šè´Ÿè½½å‡è¡¡</button>
        </div>
        <div id="debugResult" class="result-box" style="border-left-color: #6f42c1;">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <div class="section">
        <h3>ğŸ“Š è´Ÿè½½å‡è¡¡å¯è§†åŒ– (Load Balance Monitor)</h3>
        <div class="controls">
            <label>å¹¶å‘æ•°: <input type="number" id="reqCount" value="50"></label>
            <label>å¼ºåº¦: <input type="number" id="complexity" value="2000000"></label>
            <button class="btn-green" id="btnStress" onclick="startStressTest()">ğŸ”¥ å¼€å¯å‹æµ‹</button>
            <button class="btn-gray" onclick="clearScreen()">æ¸…ç©º</button>
        </div>

        <div class="stats">
            <span style="color:#28a745">èŠ‚ç‚¹ A: <span id="countA" class="badge" style="background:#28a745">0</span></span>
            <span style="color:#dc3545">èŠ‚ç‚¹ B: <span id="countB" class="badge" style="background:#dc3545">0</span></span>
        </div>
        <div id="monitor"></div>
    </div>
</div>

<script>
    // --- 1. è®¢å•åŠŸèƒ½ (æ‰¾å›çš„åŠŸèƒ½) ---
    async function createOrder() {
        const id = document.getElementById('orderId').value;
        const resultBox = document.getElementById('orderResult');

        resultBox.innerHTML = "ä¸‹å•è¯·æ±‚å‘é€ä¸­...";
        resultBox.style.opacity = "0.5";

        try {
            // è¿™é‡Œè°ƒç”¨ä½ åœ¨ OrderController é‡Œçš„ @GetMapping("/buy")
            const res = await fetch(`/buy?id=${id}`);
            const text = await res.text();

            resultBox.innerHTML = `âœ… ${text} <span style='font-size:0.8em; color:#999'>(Server Time: ${new Date().toLocaleTimeString()})</span>`;
            resultBox.style.opacity = "1";
        } catch (e) {
            resultBox.innerHTML = "âŒ è¯·æ±‚å¤±è´¥: " + e;
            resultBox.style.opacity = "1";
        }
    }

    // --- 2. è®¡ç®—å™¨è°ƒè¯•åŠŸèƒ½ ---
    async function testApi(endpoint, divId) {
        const count = document.getElementById('debugCount').value;
        const resultDiv = document.getElementById(divId);
        resultDiv.innerHTML = "è®¡ç®—ä¸­...";
        try {
            const res = await fetch(`${endpoint}?count=${count}`);
            const text = await res.text();
            resultDiv.innerHTML = text;
        } catch (e) {
            resultDiv.innerText = "è¯·æ±‚å¤±è´¥: " + e;
        }
    }

    // --- 3. å¯è§†åŒ–å‹æµ‹åŠŸèƒ½ (ä¿æŒåŸæ ·) ---
    let countMap = {};

    async function startStressTest() {
        const btn = document.getElementById('btnStress');
        const count = document.getElementById('reqCount').value;
        const complexity = document.getElementById('complexity').value;

        btn.disabled = true;
        btn.innerText = "å‹æµ‹è¿›è¡Œä¸­...";

        const promises = [];
        for (let i = 0; i < count; i++) {
            await new Promise(r => setTimeout(r, 10));
            promises.push(sendVisualizeRequest(complexity));
        }

        await Promise.all(promises);
        btn.disabled = false;
        btn.innerText = "ğŸ”¥ å¼€å¯å‹æµ‹";
    }

    async function sendVisualizeRequest(complexity) {
        try {
            const res = await fetch(`/api/visualize?count=${complexity}`);
            const data = await res.json();
            addBlock(data.node, data.cost);
        } catch (e) { console.error(e); }
    }

    function addBlock(nodeIp, cost) {
        const monitor = document.getElementById('monitor');
        const div = document.createElement('div');
        div.className = 'block';
        div.innerText = cost + 'ms';
        div.title = "èŠ‚ç‚¹: " + nodeIp;

        if (!countMap[nodeIp]) countMap[nodeIp] = 0;
        countMap[nodeIp]++;

        const ips = Object.keys(countMap);
        const index = ips.indexOf(nodeIp);

        if (index === 0) {
            div.style.backgroundColor = '#28a745'; // ç»¿è‰²
            document.getElementById('countA').innerText = countMap[nodeIp];
        } else {
            div.style.backgroundColor = '#dc3545'; // çº¢è‰²
            document.getElementById('countB').innerText = countMap[nodeIp];
        }
        monitor.appendChild(div);
        monitor.scrollTop = monitor.scrollHeight;
    }

    function clearScreen() {
        document.getElementById('monitor').innerHTML = '';
        document.getElementById('countA').innerText = '0';
        document.getElementById('countB').innerText = '0';
        countMap = {};
    }
</script>

</body>
</html>